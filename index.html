<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>我的照片地图</title>
  <meta name="description" content="GitHub Pages 版：同仓库加载 places.json 与 photos（带校验与缓存规避）" />
  <script src="https://webapi.amap.com/maps?v=2.0&key=723e8970858641734a4d5823c8c8351b&plugin=AMap.ToolBar,AMap.Scale,AMap.Geolocation,AMap.MarkerClusterer"></script>
  <style>
    html,body{height:100%;margin:0}
    #app{height:100%;display:grid;grid-template-rows:auto 1fr}
    .topbar{display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;background:#111827;color:#fff}
    .topbar h1{font-size:1rem;margin:0;font-weight:600}
    .btn{appearance:none;border:0;border-radius:10px;padding:.45rem .7rem;background:#2563eb;color:#fff;cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    #map{position:relative;height:100%}
    .marker-label{background:#111827d9;color:#fff;border-radius:999px;padding:.2rem .5rem;font-size:.75rem;border:1px solid #374151;white-space:nowrap}
    .toast{position:fixed;right:12px;bottom:12px;background:#111827;color:#fff;padding:.6rem .8rem;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.25);max-width:90vw;z-index:9999}
    .toast a{color:#60a5fa}
  </style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <h1>我的照片地图</h1>
    <button id="fitBtn" class="btn">全览</button>
  </div>
  <div id="map"></div>
</div>

<script>
// 统一的数据地址：同目录的 places.json，并加入时间戳避免缓存
const DATA_URL = './places.json?v=' + Date.now();

function toast(msg){
  const el = document.createElement('div');
  el.className = 'toast';
  el.innerHTML = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 6000);
}

// 严格校验坐标合法性
function isValidLngLat(p){
  return Array.isArray(p.lnglat) &&
         p.lnglat.length === 2 &&
         p.lnglat.every(n => typeof n === 'number' && isFinite(n));
}

async function loadJSON(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

function createInfoContent(p){
  const img = (p.photos && p.photos[0]) ? `<div style="margin-top:6px"><img src="${p.photos[0]}" alt="${p.title||''}" style="width:240px;max-width:70vw;height:160px;object-fit:cover;border-radius:8px"></div>` : '';
  const desc = p.desc ? `<div style="margin-top:4px;color:#374151">${p.desc}</div>` : '';
  const addr = p.address ? `<div style="margin-top:4px;color:#6b7280">${p.address}</div>` : '';
  const open = (p.lnglat && p.lnglat.length===2)
    ? `<div style="margin-top:6px"><a href="https://uri.amap.com/marker?position=${p.lnglat[0]},${p.lnglat[1]}&name=${encodeURIComponent(p.title||'位置')}" target="_blank" rel="noreferrer">在高德中打开</a></div>`
    : '';
  return `<div style="font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,PingFang SC,'Microsoft YaHei',Noto Sans CJK SC,sans-serif">
    <div style="font-weight:600;font-size:16px">${p.title||'未命名位置'}</div>
    ${addr}${desc}${img}${open}
  </div>`;
}

function fitTo(map, list){
  if(!list.length) return;
  const bounds = new AMap.Bounds(list.reduce((acc,p)=>{
    const [lng,lat] = p.lnglat; return [
      [Math.min(acc[0][0], lng), Math.min(acc[0][1], lat)],
      [Math.max(acc[1][0], lng), Math.max(acc[1][1], lat)]
    ];
  }, [[Infinity,Infinity],[-Infinity,-Infinity]]));
  map.setBounds(bounds, false, [60,60,60,60]);
}

async function boot(){
  let data;
  try{
    data = await loadJSON(DATA_URL);
  }catch(e){
    alert('加载数据失败：' + e.message + '\n\n请检查：\n1) 本页与 places.json 是否同目录\n2) GitHub Pages 是否已部署完成');
    throw e;
  }

  if(!Array.isArray(data)) throw new Error('places.json 需要是数组');
  console.log('Loaded data:', data);

  const invalid = data.filter(p=>!isValidLngLat(p));
  if(invalid.length){
    console.warn('无效坐标的点位：', invalid);
    toast('⚠️ 有 ' + invalid.length + ' 个点坐标无效，已跳过。请检查 places.json 中的 lnglat。');
  }
  const list = data.filter(isValidLngLat);

  const map = new AMap.Map('map', {
    zoom: 12,
    center: (list[0] && list[0].lnglat) ? list[0].lnglat : [116.397389, 39.908722],
    mapStyle: 'amap://styles/whitesmoke'
  });
  map.addControl(new AMap.ToolBar());
  map.addControl(new AMap.Scale());

  const infoWindow = new AMap.InfoWindow({offset: new AMap.Pixel(0, -20)});
  const markers = list.map((p, idx) => {
    const m = new AMap.Marker({ position: p.lnglat, title: p.title||'位置', anchor: 'bottom-center' });
    m.setLabel({ direction: 'top', offset: new AMap.Pixel(0, -10), content: `<div class="marker-label">${idx+1}. ${p.title||'位置'}</div>` });
    m.on('click', ()=>{
      infoWindow.setContent(createInfoContent(p));
      infoWindow.open(map, m.getPosition());
    });
    return m;
  });
  if(markers.length){
    map.add(markers);
    new AMap.MarkerClusterer(map, markers, { gridSize: 80 });
    fitTo(map, list);
  }

  document.getElementById('fitBtn').onclick = ()=> fitTo(map, list);
}

boot().catch(e=>{
  console.error(e);
});
</script>
</body>
</html>
